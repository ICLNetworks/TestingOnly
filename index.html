<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Image Compressor Machi</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
    }

    .container {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    h2 {
        margin-top: 0;
    }

    .drop-zone {
        border: 2px dashed #888;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .drop-zone img {
        max-width: 200px;
        margin-top: 15px;
    }

    .preview-box {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .preview-item {
        width: 160px;
        background: #fff;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
    }

    .preview-item img {
        width: 100%;
        border-radius: 6px;
    }

    .progress {
        width: 100%;
        background: #eee;
        height: 6px;
        border-radius: 4px;
        margin-top: 6px;
    }

    .progress-inner {
        height: 100%;
        background: #4caf50;
        width: 0%;
        border-radius: 4px;
    }

    .modal-bg {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.75);
        justify-content: center;
        align-items: center;
        z-index: 999;
    }

    .modal-box {
        background: white;
        width: 90%;
        max-width: 900px;
        padding: 20px;
        border-radius: 12px;
    }

    .compare-box {
        display: flex;
        gap: 20px;
    }

    .compare-box img {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #ddd;
    }

    .close-btn {
        margin-top: 20px;
        background: #e74c3c;
        padding: 10px 20px;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        border: none;
    }

</style>
</head>
<body>

<div class="container">

    <h2>Image Compressor Machi ðŸ”¥</h2>

    <!-- WIDTH / HEIGHT -->
    <label>Width:</label>
    <input type="number" id="width" value="800">
    <label>Height:</label>
    <input type="number" id="height" value="800">

    <!-- DROP ZONE -->
    <div class="drop-zone" id="dropZone">
        <p>Drag & Drop Images Here<br>or Click to Upload</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
    </div>

    <!-- PREVIEWS -->
    <div id="previewArea" class="preview-box"></div>

    <!-- DOWNLOAD ZIP -->
    <button id="downloadZipBtn" style="display:none; margin-top:20px; padding:10px 20px; border:none; background:#3498db; color:white; border-radius:6px;">
        Download All (ZIP)
    </button>

</div>

<!-- MODAL -->
<div class="modal-bg" id="modalBg">
    <div class="modal-box">
        <h3>Before / After Comparison</h3>
        <div class="compare-box">
            <img id="beforeImg">
            <img id="afterImg">
        </div>
        <button class="close-btn" onclick="closeModal()">Close</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
let dropZone = document.getElementById("dropZone");
let fileInput = document.getElementById("fileInput");
let previewArea = document.getElementById("previewArea");
let widthInput = document.getElementById("width");
let heightInput = document.getElementById("height");
let downloadZipBtn = document.getElementById("downloadZipBtn");
let zip = new JSZip();
let zipCount = 0;

// Drop zone click
dropZone.onclick = () => fileInput.click();

// Drag events
dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = "#e8e8e8"; };
dropZone.ondragleave = () => { dropZone.style.background = "#fafafa"; };
dropZone.ondrop = (e) => {
    e.preventDefault();
    dropZone.style.background = "#fafafa";
    handleFiles(e.dataTransfer.files);
};

// File input change
fileInput.onchange = () => handleFiles(fileInput.files);

function handleFiles(files) {
    [...files].forEach(file => processFile(file));
}

// Process image
function processFile(file) {
    let reader = new FileReader();
    reader.onload = function(event) {

        // Create preview item
        let item = document.createElement("div");
        item.className = "preview-item";

        item.innerHTML = `
            <img src="${event.target.result}">
            <p>${file.name}</p>
            <p><b>Before:</b> ${(file.size/1024).toFixed(1)} KB</p>
            <p id="after-${zipCount}"><b>After:</b> ...</p>

            <div class="progress"><div class="progress-inner" id="prog-${zipCount}"></div></div>

            <button onclick="openCompareModal('${event.target.result}', '${file.name}', ${zipCount})">Compare</button>
        `;

        previewArea.appendChild(item);

        compressImage(event.target.result, file.name, zipCount);
        zipCount++;
    };
    reader.readAsDataURL(file);
}

function compressImage(dataUrl, filename, id) {
    let img = new Image();
    img.src = dataUrl;

    img.onload = function() {

        let w = parseInt(widthInput.value);
        let h = parseInt(heightInput.value);

        // Manual resize (A1)
        let canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;

        let ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        let compressed = canvas.toDataURL("image/jpeg", 0.8);

        // Update preview
        document.getElementById("prog-" + id).style.width = "100%";

        let afterSize = Math.round((compressed.length * 3/4) / 1024);
        document.getElementById("after-" + id).innerHTML = `<b>After:</b> ${afterSize} KB`;

        // Add to ZIP
        zip.file(filename, compressed.split(",")[1], {base64:true});
        downloadZipBtn.style.display = "inline-block";
    };
}

// Modal compare
function openCompareModal(beforeData, filename, id) {

    // Load compressed image from zip temp
    zip.files[filename].async("base64").then(base64 => {

        document.getElementById("beforeImg").src = beforeData;
        document.getElementById("afterImg").src = "data:image/jpeg;base64," + base64;

        document.getElementById("modalBg").style.display = "flex";
    });
}

function closeModal() {
    document.getElementById("modalBg").style.display = "none";
}

// Download ZIP
downloadZipBtn.onclick = () => {
    zip.generateAsync({type:"blob"}).then(blob => {
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "compressed_images.zip";
        a.click();
    });
};
</script>

</body>
</html>
